<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>zoe | blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="keywords" content="zoe zoexx coding zoexx.github.io">
  <meta name="baidu-site-verification" content="udDjGff8vn" />
  <meta name="description" content="just what u see">
<meta property="og:type" content="website">
<meta property="og:title" content="zoe | blog">
<meta property="og:url" content="http://zoexx.github.io/page/2/index.html">
<meta property="og:site_name" content="zoe | blog">
<meta property="og:description" content="just what u see">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="zoe | blog">
<meta name="twitter:description" content="just what u see">
  
    <link rel="alternative" href="/atom.xml" title="zoe | blog" type="application/atom+xml">
  
  
    <link rel="icon" href="https://cdn.zoeservers.com/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
    <link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="https://cdn.zoeservers.com/myMarioBlue.jpg" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">Zoe Ying</a></h1>
		</hgroup>

		
		<p class="header-subtitle">瞎叨叨</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://zoexx.github.io/" title="github">github</a>
					        
								<a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/SPA/" style="font-size: 10px;">SPA</a> <a href="/tags/flutter/" style="font-size: 10px;">flutter</a> <a href="/tags/git/" style="font-size: 10px;">git</a> <a href="/tags/git-git-flow/" style="font-size: 10px;">git git-flow</a> <a href="/tags/gulp/" style="font-size: 10px;">gulp</a> <a href="/tags/http/" style="font-size: 10px;">http</a> <a href="/tags/hybird/" style="font-size: 10px;">hybird</a> <a href="/tags/ideas/" style="font-size: 10px;">ideas</a> <a href="/tags/javascript/" style="font-size: 20px;">javascript</a> <a href="/tags/life/" style="font-size: 16.67px;">life</a> <a href="/tags/linux/" style="font-size: 13.33px;">linux</a> <a href="/tags/linux-dueros/" style="font-size: 10px;">linux dueros</a> <a href="/tags/mailchimp/" style="font-size: 10px;">mailchimp</a> <a href="/tags/mobile/" style="font-size: 10px;">mobile</a> <a href="/tags/node/" style="font-size: 10px;">node</a> <a href="/tags/php-wechat/" style="font-size: 10px;">php wechat</a> <a href="/tags/qshell-tool/" style="font-size: 10px;">qshell tool</a> <a href="/tags/raspberry/" style="font-size: 10px;">raspberry</a> <a href="/tags/tools/" style="font-size: 10px;">tools</a> <a href="/tags/vue/" style="font-size: 10px;">vue</a> <a href="/tags/wechat-小程序/" style="font-size: 10px;">wechat 小程序</a> <a href="/tags/微信小程序/" style="font-size: 10px;">微信小程序</a>
					</div>
				</section>
				
				
				

				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">Zoe Ying</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="https://cdn.zoeservers.com/myMarioBlue.jpg" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author">Zoe Ying</h1>
			</hgroup>
			
			<p class="header-subtitle">瞎叨叨</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://zoexx.github.io/" title="github">github</a>
			        
						<a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap">
  
    <article id="post-qshell-upload" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/12/29/qshell-upload/" class="article-date">
  	<time datetime="2017-12-29T08:26:38.000Z" itemprop="datePublished">2017-12-29</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/12/29/qshell-upload/">qshell_upload</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="使用qshell上传资源到七牛"><a href="#使用qshell上传资源到七牛" class="headerlink" title="使用qshell上传资源到七牛"></a>使用qshell上传资源到七牛</h1><h4 id="首先下载qshell"><a href="#首先下载qshell" class="headerlink" title="首先下载qshell"></a>首先<a href="https://developer.qiniu.com/kodo/tools/1302/qshell#2" target="_blank" rel="external">下载qshell</a></h4><h4 id="接着-登录账户文档"><a href="#接着-登录账户文档" class="headerlink" title="接着 登录账户文档"></a>接着 登录账户<a href="https://developer.qiniu.com/kodo/tools/1302/qshell#4" target="_blank" rel="external">文档</a></h4><h4 id="批量上传只需要用到两个命令-dircache-和-qupload"><a href="#批量上传只需要用到两个命令-dircache-和-qupload" class="headerlink" title="批量上传只需要用到两个命令 dircache  和 qupload"></a>批量上传只需要用到两个命令 dircache  和 qupload</h4><p><a href="https://github.com/qiniu/qshell/blob/master/docs/dircache.md" target="_blank" rel="external">dircache 文档</a></p>
<p><a href="https://github.com/qiniu/qshell/blob/master/docs/qupload.md" target="_blank" rel="external">qupload 文档</a></p>
<h4 id="举个🌰"><a href="#举个🌰" class="headerlink" title="举个🌰"></a>举个🌰</h4><p>以下是我的本地目录结构，使用多个帐号可以根据官方推荐的方法分目录存放账户信息</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">│  file_list<span class="class">.txt</span></span><br><span class="line">│  qshell<span class="class">.exe</span></span><br><span class="line">│  success<span class="class">.txt</span></span><br><span class="line">│  upload<span class="class">.conf</span></span><br><span class="line">│  upload<span class="class">.log</span></span><br><span class="line">│</span><br><span class="line">└─ibt</span><br><span class="line">    └─<span class="class">.qshell</span></span><br><span class="line">            account.json</span><br></pre></td></tr></table></figure>
<p>列举文件</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qshell.exe dircache C:<span class="command">\Users</span><span class="command">\ibesteeth</span><span class="command">\Documents</span><span class="command">\www</span><span class="command">\public</span><span class="command">\activity</span><span class="command">\annual</span>_report file_list.txt</span><br></pre></td></tr></table></figure>
<p>配置上传 <a href="https://github.com/qiniu/qshell/blob/master/docs/qupload.md#%E9%85%8D%E7%BD%AE" target="_blank" rel="external">配置文档</a></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">touch upload.conf</span><br><span class="line">vim upload.conf</span><br><span class="line">&#123;</span><br><span class="line">   <span class="string">"src_dir"</span>            :   <span class="string">"C:\\Users\\ibesteeth\\Documents\\www\\public\\activity\\annual_report"</span>,</span><br><span class="line">   <span class="string">"bucket"</span>             :   <span class="string">"webstatic"</span>,</span><br><span class="line">   <span class="string">"file_list"</span>          :   <span class="string">"C:\\Users\\ibesteeth\\Documents\\qshell\\file_list.txt"</span>,</span><br><span class="line">   <span class="string">"key_prefix"</span>         :   <span class="string">"activity/annual_report/"</span>,</span><br><span class="line">   <span class="string">"ignore_dir"</span>         :   <span class="literal">false</span>,</span><br><span class="line">   <span class="string">"overwrite"</span>          :   <span class="literal">true</span>,</span><br><span class="line">   <span class="string">"check_exists"</span>       :   <span class="literal">false</span>,</span><br><span class="line">   <span class="string">"check_hash"</span>         :   <span class="literal">false</span>,</span><br><span class="line">   <span class="string">"check_size"</span>         :   <span class="literal">false</span>,</span><br><span class="line">   <span class="string">"rescan_local"</span>       :   <span class="literal">true</span>,</span><br><span class="line">   <span class="string">"skip_suffixes"</span>      :   <span class="string">".DS_Store,.exe,.html,.db"</span>,</span><br><span class="line">   <span class="string">"log_file"</span>           :   <span class="string">"upload.log"</span>,</span><br><span class="line">   <span class="string">"log_level"</span>          :   <span class="string">"debug"</span>,</span><br><span class="line">   <span class="string">"log_rotate"</span>         :   <span class="number">1</span>,</span><br><span class="line">   <span class="string">"log_stdout"</span>         :   <span class="literal">true</span>,</span><br><span class="line">   <span class="string">"file_type"</span>          :   <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>开始上传</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qshell<span class="class">.exe</span> qupload -success-list success<span class="class">.txt</span> upload.conf</span><br></pre></td></tr></table></figure>
      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/qshell-tool/">qshell tool</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>










  
    <article id="post-dueros-v1" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/12/05/dueros-v1/" class="article-date">
  	<time datetime="2017-12-05T02:54:30.000Z" itemprop="datePublished">2017-12-05</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/12/05/dueros-v1/">dueros_v1</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h4 id="这是一篇-2017-12-05-在dueros开发论坛记录的帖子-搬运过来"><a href="#这是一篇-2017-12-05-在dueros开发论坛记录的帖子-搬运过来" class="headerlink" title="这是一篇 2017-12-05 在dueros开发论坛记录的帖子 搬运过来"></a>这是一篇 2017-12-05 在dueros开发论坛记录的帖子 搬运过来</h4><p>⭐⭐⭐⭐ 等了好久等了好久的 开 箱 ⭐⭐⭐⭐</p>
<p><img src="http://boscdn.bpc.baidu.com/v1/developer/1512462305290081022.jpg" alt="1512462305290081022.jpg"></p>
<p><img src="http://boscdn.bpc.baidu.com/v1/developer/1512462319791021976.jpg" alt="1512462319791021976.jpg"></p>
<p>立即下单的树莓派跟tf卡也在第二天收到~~~~</p>
<p><img src="http://boscdn.bpc.baidu.com/v1/developer/1512462354443027445.jpg" alt="1512462354443027445.jpg"></p>
<p>刷镜像这一步就不啰嗦了，请参考<a href="https://developer.dueros.baidu.com/doc/device-devkit/intro_markdown" target="_blank" rel="external">官方说明</a>。</p>
<p>刷好镜像之后改wifi配置（此时依然是用电脑打开tf卡的目录）：</p>
<ol>
<li>在tf卡根目录新建一个ssh文件</li>
<li>新建一个wpa_supplicant.conf文件，并加入wifi配置</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">touch ssh</span><br><span class="line">touch wpa_supplicant.conf</span><br><span class="line">vim wpa_supplicant.conf</span><br></pre></td></tr></table></figure>
<pre><code>以下是文件内容：
</code></pre><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">country=GB&#10;ctrl_interface=DIR=/var/run/wpa_supplicant&#160;GROUP=netdev&#10;update_config=1&#10;network=&#123;&#10;&#160;&#160;&#160;&#160;ssid=&#34;wifi&#160;ssid&#34;&#10;&#160;&#160;&#160;&#160;psk=&#34;password&#34;&#10;&#125;</span><br></pre></td></tr></table></figure>
<p>即可。</p>
<p>装卡，通电，找ip。</p>
<p>ip可以登录路由器的管理页面去找，</p>
<p>如果，有人跟我一样，</p>
<p>没有管理帐号，那么，可以用ipscan来找一找。</p>
<p>献上软件</p>
<p>链接: <a href="https://pan.baidu.com/s/1i51UCN7" target="_blank" rel="external">https://pan.baidu.com/s/1i51UCN7</a> 密码: kr4n</p>
<p>扫描一下局域网内的ip，找找有包含raspberry,linux之类字样的，</p>
<p>如果，有人跟我一样，</p>
<p>没有找到任何特征。</p>
<p><img src="http://boscdn.bpc.baidu.com/v1/developer/1512462040931003322.png" alt="1512462040931003322.png"></p>
<p>那么就用排除法吧！</p>
<p>筛选之后，我这边剩余19个没有任何特征的ip，一个一个ssh过去，(┬＿┬)</p>
<p><img src="http://boscdn.bpc.baidu.com/v1/developer/1512462057540082439.png" alt="1512462057540082439.png"></p>
<p>好歹是找到了。</p>
<p>用top观察一下下，dueros跑的很安逸。</p>
<p><img src="http://boscdn.bpc.baidu.com/v1/developer/1512462067106027182.png" alt="1512462067106027182.png"></p>
<p>中午吃完午饭回来，摸摸pi的cpu，嗯，还是挺温暖的。</p>
<p>拔电源，连接上板子，给电，小度温柔的声音出来啦</p>
<p>“小度正在启动请稍候…”</p>
<p>“启动成功~”</p>
<p>“小度小度~”</p>
<p>“…”</p>
<p>“小度小度 ?”</p>
<p>“…..”</p>
<p>“小度小度 !”</p>
<p>“…..”</p>
<p>最怕空气突然安静…..</p>
<p>查看一下日志</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tail <span class="operator">-f</span> /duer/duer_linux.log</span><br></pre></td></tr></table></figure>
<p>果然是报错了……</p>
<p><img src="http://boscdn.bpc.baidu.com/v1/developer/1512462125923052655.png" alt="1512462125923052655.png"></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Can&#39;t open &#34;plughw:1,0&#34; PCM device. No such file or directory</span><br></pre></td></tr></table></figure>
<p>看上去好像是找不到什么设备，怀疑每一根链接线</p>
<p>立即在群里询问</p>
<p>经群里的小伙伴提示，换了根micro usb线，即可正常运行。</p>
<p>（之前用的是一根给设备充电的短线）</p>
<p>这个PCM device是什么意思呢，PCM是pulse code modulation，中文译名是脉冲编码调制。在这里我理解为录音和播放音频的设备（模拟信号和数字信号之间的转换），如有错误大家指出。</p>
<p>这里有一篇文章介绍<a href="http://blog.csdn.net/junglyfine/article/details/8665589" target="_blank" rel="external">PCM是什么</a></p>
<p><img src="http://boscdn.bpc.baidu.com/v1/developer/1512462153975069787.png" alt="1512462153975069787.png"></p>
<p><img src="http://boscdn.bpc.baidu.com/v1/developer/1512462181885004181.png" alt="1512462181885004181.png"></p>
<p>((유∀유|||)) 好像我并没有呵呵呵的傻笑昂</p>
<p>这里也可以看到语音识别的返回信息（摊手）：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[App-INFO&#160;]-[2017-12-05&#160;15:17:32.161]-----Duer&#160;server&#160;data:&#123;&#10;&#160;&#160;&#160;&#34;client_msg_id&#34;&#160;:&#160;&#34;aee7c92d-0b63-4283-b80f-940e6beec458&#34;,&#10;&#160;&#160;&#160;&#34;cuid&#34;&#160;:&#160;&#34;7b4ac26c65ac73db4f30f334ac80b013&#34;,&#10;&#160;&#160;&#160;&#34;id&#34;&#160;:&#160;&#34;1512458252_136cskpp6&#34;,&#10;&#160;&#160;&#160;&#34;idx&#34;&#160;:&#160;4,&#10;&#160;&#160;&#160;&#34;logid&#34;&#160;:&#160;&#34;15124582511915&#34;,&#10;&#160;&#160;&#160;&#34;msg&#34;&#160;:&#160;&#34;ok&#34;,&#10;&#160;&#160;&#160;&#34;result&#34;&#160;:&#160;&#123;&#10;&#160;&#160;&#160;&#160;&#160;&#160;&#34;bot_id&#34;&#160;:&#160;&#34;talk_service&#34;,&#10;&#160;&#160;&#160;&#160;&#160;&#160;&#34;bot_meta&#34;&#160;:&#160;&#123;&#10;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#34;description&#34;&#160;:&#160;&#34;desc&#34;,&#10;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#34;type&#34;&#160;:&#160;&#34;&#20854;&#20182;&#34;,&#10;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#34;version&#34;&#160;:&#160;&#34;1.0.0&#34;&#10;&#160;&#160;&#160;&#160;&#160;&#160;&#125;,&#10;&#160;&#160;&#160;&#160;&#160;&#160;&#34;directives&#34;&#160;:&#160;[&#10;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#123;&#10;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#34;header&#34;&#160;:&#160;&#123;&#10;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#34;dialogRequestId&#34;&#160;:&#160;&#34;aee7c92d-0b63-4283-b80f-940e6beec458&#34;,&#10;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#34;name&#34;&#160;:&#160;&#34;Speak&#34;,&#10;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#34;namespace&#34;&#160;:&#160;&#34;SpeechSynthesizer&#34;&#10;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#125;,&#10;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#34;payload&#34;&#160;:&#160;&#123;&#10;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#34;content&#34;&#160;:&#160;[&#160;&#34;&#21621;&#21621;&#21621;&#30340;&#20667;&#31505;&#12290;&#21621;&#21621;&#21621;&#30340;&#20667;&#31505;&#34;&#160;],&#10;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#34;speak_behavior&#34;&#160;:&#160;&#34;REPLACE_ALL&#34;,&#10;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#34;token&#34;&#160;:&#160;&#34;1512458252_123fr0kcl&#34;,&#10;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#34;type&#34;&#160;:&#160;&#34;Text&#34;&#10;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#125;&#10;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#125;&#10;&#160;&#160;&#160;&#160;&#160;&#160;],&#10;&#160;&#160;&#160;&#160;&#160;&#160;&#34;display&#34;&#160;:&#160;&#123;&#10;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#34;id&#34;&#160;:&#160;&#34;af9b0b03baa4665c7bb8002327edcf65&#34;,&#10;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#34;url&#34;&#160;:&#160;&#34;http://xiaodu.baidu.com/saiya/dcsview?id=af9b0b03baa4665c7bb8002327edcf65&#38;appid=dmB3C032D9FD3E4899&#34;;&#10;&#160;&#160;&#160;&#160;&#160;&#160;&#125;,&#10;&#160;&#160;&#160;&#160;&#160;&#160;&#34;nlu&#34;&#160;:&#160;&#123;&#10;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#34;domain&#34;&#160;:&#160;&#34;unknown&#34;,&#10;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#34;intent&#34;&#160;:&#160;&#34;unknown&#34;,&#10;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#34;slots&#34;&#160;:&#160;&#123;&#125;&#10;&#160;&#160;&#160;&#160;&#160;&#160;&#125;,&#10;&#160;&#160;&#160;&#160;&#160;&#160;&#34;speech&#34;&#160;:&#160;&#123;&#10;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#34;content&#34;&#160;:&#160;&#34;&#21621;&#21621;&#21621;&#30340;&#20667;&#31505;&#12290;&#21621;&#21621;&#21621;&#30340;&#20667;&#31505;&#34;,&#10;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#34;type&#34;&#160;:&#160;&#34;Text&#34;&#10;&#160;&#160;&#160;&#160;&#160;&#160;&#125;,&#10;&#160;&#160;&#160;&#160;&#160;&#160;&#34;views&#34;&#160;:&#160;[&#10;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#123;&#10;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#34;content&#34;&#160;:&#160;&#34;&#21621;&#21621;&#21621;&#30340;&#20667;&#31505;&#34;,&#10;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#34;type&#34;&#160;:&#160;&#34;txt&#34;&#10;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#125;,&#10;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#123;&#10;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#34;list&#34;&#160;:&#160;[&#10;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#123;&#10;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#34;src&#34;&#160;:&#160;&#34;https://ss3.baidu.com/-fo3dSag_xI4khGko9WTAnF6hhy/xiaodu/pic/item/d1160924ab18972be2049786eecd7b899e510abb.jpg&#34;;&#10;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#125;&#10;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;],&#10;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#34;type&#34;&#160;:&#160;&#34;image&#34;&#10;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#125;&#10;&#160;&#160;&#160;&#160;&#160;&#160;]&#10;&#160;&#160;&#160;&#125;,&#10;&#160;&#160;&#160;&#34;se_query&#34;&#160;:&#160;&#34;&#21621;&#21621;&#21621;&#21621;&#21621;&#21621;&#21621;&#21621;&#21621;&#21621;&#21621;&#21621;&#34;,&#10;&#160;&#160;&#160;&#34;session_id&#34;&#160;:&#160;&#34;86dc7a52-cb5d-4448-b9b4-f7610fd278bc&#34;,&#10;&#160;&#160;&#160;&#34;speech_id&#34;&#160;:&#160;&#34;6495958712883389696&#34;,&#10;&#160;&#160;&#160;&#34;status&#34;&#160;:&#160;0,&#10;&#160;&#160;&#160;&#34;time&#34;&#160;:&#160;1512458252,&#10;&#160;&#160;&#160;&#34;timeuse&#34;&#160;:&#160;748,&#10;&#160;&#160;&#160;&#34;user_id&#34;&#160;:&#160;&#34;7b4ac26c65ac73db4f30f334ac80b013&#34;&#10;&#125;</span><br></pre></td></tr></table></figure>
<p>okay，下一步是用pythonSDK修改唤词。</p>
<p>补充三个指令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl stop duer</span><br><span class="line">sudo systemctl start duer</span><br><span class="line">sudo systemctl <span class="built_in">disable</span> duer</span><br><span class="line">sudo systemctl <span class="built_in">enable</span> duer</span><br></pre></td></tr></table></figure>
<p>Ps:</p>
<p>看过《her》之后一直对Samantha恋恋不忘呢。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux-dueros/">linux dueros</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>










  
    <article id="post-funnyCommandInLinux" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/11/28/funnyCommandInLinux/" class="article-date">
  	<time datetime="2017-11-28T08:26:21.000Z" itemprop="datePublished">2017-11-28</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/11/28/funnyCommandInLinux/">有趣的linux（Debian）命令</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="本-APT-具有超级牛力是什么鬼？"><a href="#本-APT-具有超级牛力是什么鬼？" class="headerlink" title="本 APT 具有超级牛力是什么鬼？"></a>本 APT 具有超级牛力是什么鬼？</h2><blockquote>
<p> apt-get is the command-line tool for handling packages, and may be considered the user’s “back-end” to other tools using the APT library. Several “front-end” interfaces exist, such as aptitude(8), synaptic(8) and wajig(1).</p>
</blockquote>
<p>给系统做了汉化之后，Sean发现执行apt-get命令时，command说明的最后一行出现了“本 APT 具有超级牛力”。英文是”This APT has Super Cow Powers.”。</p>
<p><img src="http://cdn.zoeservers.com/blog/apt_20171128163821.png" alt="本 APT 具有超级牛力"></p>
<p>有趣的是<a href="https://baike.baidu.com/item/aptitude/6849487?fr=aladdin" target="_blank" rel="external">aptitude</a>的说明中也出现了牛力。</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ aptitude <span class="comment">--help</span></span><br></pre></td></tr></table></figure>
<p>“这个 aptitude 没有超级牛力。”</p>
<p>“This aptitude does not have Super Cow Powers.”</p>
<p>好吧，在此之前，我其实也有用过一个有趣的小命令，叫 cowsay 。</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pi<span class="comment">@raspberrypi:~ $ cowsay hello world</span></span><br><span class="line"> _____________</span><br><span class="line"><span class="variable">&lt; hello world &gt;</span></span><br><span class="line"> -------------</span><br><span class="line">        \   ^__^</span><br><span class="line">         \  (oo)\_______</span><br><span class="line">            (__)\       )\/\</span><br><span class="line">                ||<span class="string">----w </span>|</span><br><span class="line">                ||<span class="string">     </span>||</span><br></pre></td></tr></table></figure>
<p>那么，为什么这一堆程序员这么偏爱牛呢？🐮🐮🐮🐮</p>
<h4 id="What’s-the-story-behind-Super-Cow-Powers"><a href="#What’s-the-story-behind-Super-Cow-Powers" class="headerlink" title="What’s the story behind Super Cow Powers?"></a>What’s the story behind Super Cow Powers?</h4><blockquote>
<p>Apt started its life around 1997 and entered Debian officially around 1999. During its early days, Jason Gunthorpe was its main maintainer/developer. Well, apparently Jason liked cows. I don’t know if he still does. :-) Anyway, I think the apt-get moo thing was added by him as a joke. The corresponding aptitude easter eggs (see below) were added later by Daniel Burrows as a homage, I think.</p>
</blockquote>
<blockquote>
<p>If there is more to the story, Jason is probably the person to ask. He has (likely in response to this question) written a post on Google+. A small bit of it:</p>
</blockquote>
<blockquote>
<blockquote>
<p>Once a long time ago a developer was known for announcing his presence on IRC with a simple, to the point ‘Moo’. As with cows in pasture others would often Moo back in greeting. This led to a certain range of cow based jokes.</p>
</blockquote>
</blockquote>
<p>以上是来自<a href="https://unix.stackexchange.com/questions/92185/whats-the-story-behind-super-cow-powers" target="_blank" rel="external">unix.stackexchange.com</a>的高票回答。</p>
<p>吼，原来是<a href="https://baike.baidu.com/item/IRC/10410?fr=aladdin" target="_blank" rel="external">IRC</a>( Internet Relay Chat )时代的故事。</p>
<p>脑补对话:</p>
<ul>
<li>zoe: moo.    </li>
<li><small>( anyone else? )</small></li>
<li>sean: moo~   </li>
<li><small>( yes,here. )</small></li>
<li>della: moo~  </li>
<li><small>( here I am. )</small></li>
</ul>
<h4 id="更多牛力请尝试👇"><a href="#更多牛力请尝试👇" class="headerlink" title="更多牛力请尝试👇"></a>更多牛力请尝试👇</h4><p>万圣节彩蛋？<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ </span>aptitude moo</span><br><span class="line"><span class="variable">$ </span>aptitude -v moo</span><br><span class="line"><span class="variable">$ </span>aptitude -vv moo</span><br><span class="line"><span class="variable">$ </span>aptitude -vvv moo</span><br><span class="line"><span class="variable">$ </span>aptitude -vvvv moo</span><br><span class="line"><span class="variable">$ </span>aptitude -vvvvv moo</span><br><span class="line"><span class="variable">$ </span>aptitude -vvvvvv moo</span><br></pre></td></tr></table></figure></p>
<p>Have you mooed today?<br><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ apt-<span class="keyword">get</span> moo</span><br><span class="line">$ apt-<span class="keyword">get</span> moo moo</span><br><span class="line">$ apt-<span class="keyword">get</span> moo moo moo</span><br></pre></td></tr></table></figure></p>
<p>其实cowsay不仅仅🐮say，还有很多小动物<br>Show all available cows<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="keyword">for</span> i <span class="keyword">in</span> /usr/share/cowsay/cows/*.cow; <span class="keyword">do</span> cowsay <span class="operator">-f</span> <span class="variable">$i</span> <span class="string">"<span class="variable">$i</span>"</span>; <span class="keyword">done</span></span><br></pre></td></tr></table></figure></p>
<h4 id="其它有趣的命令（有一些是没有打包在系统中的需要手动装一下，apt-get-install-in-Debian）"><a href="#其它有趣的命令（有一些是没有打包在系统中的需要手动装一下，apt-get-install-in-Debian）" class="headerlink" title="其它有趣的命令（有一些是没有打包在系统中的需要手动装一下，apt-get install in Debian）"></a>其它有趣的命令（有一些是没有打包在系统中的需要手动装一下，apt-get install in Debian）</h4><h5 id="1-sl大家应该都知道，手误的时候可以看火车呜呜呜的经过"><a href="#1-sl大家应该都知道，手误的时候可以看火车呜呜呜的经过" class="headerlink" title="1. sl大家应该都知道，手误的时候可以看火车呜呜呜的经过"></a>1. sl大家应该都知道，手误的时候可以看火车呜呜呜的经过</h5><h5 id="2-cmatrix-屏保-🙂-黑客帝国的大门为你打开（假装）"><a href="#2-cmatrix-屏保-🙂-黑客帝国的大门为你打开（假装）" class="headerlink" title="2. cmatrix 屏保 🙂 黑客帝国的大门为你打开（假装）"></a>2. cmatrix 屏保 🙂 黑客帝国的大门为你打开（假装）</h5><h5 id="3-fortune"><a href="#3-fortune" class="headerlink" title="3. fortune"></a>3. fortune</h5><p>美国中餐馆的最后一道菜，往往是小甜饼，叫做”幸运饼”（fortune cookie）。里面有一张纸条，写着人生格言。</p>
<p><img src="https://timgsa.baidu.com/timg?image&amp;quality=80&amp;size=b9999_10000&amp;sec=1512466632&amp;di=b22654281d39ca66b2085d11de46b2aa&amp;imgtype=jpg&amp;er=1&amp;src=http%3A%2F%2Ffarm1.staticflickr.com%2F53%2F120157809_d3a7ee3718.jpg" alt="fortune cookie"></p>
<p>这种形式的格言非常受欢迎，1979年，就有人写了一个叫做 fortune 的小程序。每一次执行都可以得到一条随机的格言/故事。</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="constant">pi</span>@raspberrypi:~ $ fortune</span><br><span class="line">If one cannot enjoy reading a book <span class="keyword">over</span> <span class="keyword">and</span> <span class="keyword">over</span> again, there <span class="keyword">is</span> no use</span><br><span class="line"><span class="keyword">in</span> reading <span class="keyword">it</span> <span class="keyword">at</span> all.</span><br><span class="line">		<span class="comment">-- Oscar Wilde</span></span><br></pre></td></tr></table></figure>
<p>还有中文版的 fortune-zh 。</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pi<span class="variable">@raspberrypi</span><span class="symbol">:~</span> <span class="variable">$ </span>fortune-zh</span><br><span class="line">《赠内人》</span><br><span class="line">作者：张祜</span><br><span class="line">禁门宫树月痕过，媚眼惟看宿鹭巢。</span><br><span class="line">斜拔玉钗灯影畔，剔开红焰救飞蛾。</span><br></pre></td></tr></table></figure>
<p>use fortune with cowsay ~</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">pi<span class="property">@raspberrypi</span>:~ $ fortune | cowsay</span><br><span class="line"> ________________________________________</span><br><span class="line">/ My only love sprung <span class="keyword">from</span> my only hate! <span class="string">\</span></span><br><span class="line">| Too early seen unknown, <span class="keyword">and</span> known too  |</span><br><span class="line">| late!                                  |</span><br><span class="line">|                                        |</span><br><span class="line">| -- William Shakespeare, <span class="string">"Romeo and     |</span><br><span class="line">\ Juliet"</span>                                /</span><br><span class="line"> ----------------------------------------</span><br><span class="line">        <span class="string">\</span>   ^__^</span><br><span class="line">         <span class="string">\</span>  (oo)<span class="string">\_______</span></span><br><span class="line">            (__)<span class="string">\</span>       )<span class="string">\/\</span></span><br><span class="line">                ||----w |</span><br><span class="line">                ||     ||</span><br></pre></td></tr></table></figure>
<p>Have a random “cow” say a random thing<br><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">pi@raspberrypi:~ $ fortune <span class="string">| cowsay -f $(ls /usr/share/cowsay/cows/ | shuf -n1)</span></span><br><span class="line"> ________________________________________</span><br><span class="line">/ It is a wise father that knows his own \</span><br><span class="line"><span class="string">| child.                                 |</span></span><br><span class="line"><span class="string">|                                        |</span></span><br><span class="line"><span class="string">| -- William Shakespeare, "</span>The Merchant  <span class="string">|</span></span><br><span class="line">\ of Venice<span class="string">"                             /</span></span><br><span class="line"> ----------------------------------------</span><br><span class="line"> \     /\  ___  /\</span><br><span class="line">  \   <span class="comment">// \/   \/ \\</span></span><br><span class="line">     ((    O O    ))</span><br><span class="line">      \\ /     \ <span class="comment">//</span></span><br><span class="line">       \/  <span class="string">| |  \/ </span></span><br><span class="line">        <span class="string">|  | |  |  </span></span><br><span class="line">        <span class="string">|  | |  |  </span></span><br><span class="line">        <span class="string">|   o   |  </span></span><br><span class="line">        <span class="string">| |   | |  </span></span><br><span class="line">        <span class="string">|m|   |m|</span></span><br></pre></td></tr></table></figure></p>
<h5 id="4-ddate"><a href="#4-ddate" class="headerlink" title="4. ddate"></a>4. ddate</h5><blockquote>
<p>ddate prints the date in Discordian date format.</p>
</blockquote>
<p>是否厌倦了千百年不变的<a href="https://en.wikipedia.org/wiki/Gregorian_calendar" target="_blank" rel="external"> Gregorian Calendar（罗马教历）</a>？准备好乱入了吗？试试输入“ddate”。这样会把当前日历以<a href="https://en.wikipedia.org/wiki/Discordian_calendar" target="_blank" rel="external">Discordian Calendar（不和教历）</a>的方式显示出来。你会遇见这样的语句：</p>
<p>“今天是Sweetmorn（甜美的清晨），3181年Discord（不和）季的第18天。”</p>
<h5 id="5-adventure-文字冒险游戏"><a href="#5-adventure-文字冒险游戏" class="headerlink" title="5. adventure 文字冒险游戏"></a>5. adventure 文字冒险游戏</h5><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="constant">pi</span>@raspberrypi:~ $ adventure </span><br><span class="line"></span><br><span class="line">Welcome <span class="keyword">to</span> Adventure!!  Would you like instructions?</span><br><span class="line">yes</span><br><span class="line"></span><br><span class="line">Somewhere nearby <span class="keyword">is</span> Colossal Cave, <span class="keyword">where</span> others have found fortunes <span class="keyword">in</span></span><br><span class="line">treasure <span class="keyword">and</span> gold, though <span class="keyword">it</span> <span class="keyword">is</span> rumored <span class="keyword">that</span> <span class="keyword">some</span> who enter are never</span><br><span class="line">seen again.  Magic <span class="keyword">is</span> said <span class="keyword">to</span> work <span class="keyword">in</span> <span class="keyword">the</span> cave.  I will be your eyes</span><br><span class="line"><span class="keyword">and</span> hands.  Direct <span class="keyword">me</span> <span class="keyword">with</span> commands <span class="keyword">of</span> <span class="number">1</span> <span class="keyword">or</span> <span class="number">2</span> <span class="property">words</span>.  I should warn</span><br><span class="line">you <span class="keyword">that</span> I look <span class="keyword">at</span> only <span class="keyword">the</span> <span class="keyword">first</span> five letters <span class="keyword">of</span> each <span class="property">word</span>, so you'll</span><br><span class="line">have <span class="keyword">to</span> enter <span class="string">"northeast"</span> <span class="keyword">as</span> <span class="string">"ne"</span> <span class="keyword">to</span> distinguish <span class="keyword">it</span> <span class="keyword">from</span> <span class="string">"north"</span>.</span><br><span class="line">(Should you <span class="keyword">get</span> stuck, type <span class="string">"help"</span> <span class="keyword">for</span> <span class="keyword">some</span> general hints.  For</span><br><span class="line">information <span class="function_start"><span class="keyword">on</span></span> how <span class="keyword">to</span> <span class="keyword">end</span> your adventure, etc., type <span class="string">"info"</span>.)</span><br><span class="line">			      - - -</span><br><span class="line">This program was originally developed <span class="keyword">by</span> Will Crowther.  Most <span class="keyword">of</span> <span class="keyword">the</span></span><br><span class="line">features <span class="keyword">of</span> <span class="keyword">the</span> current program were added <span class="keyword">by</span> Don Woods.  Address</span><br><span class="line">complaints <span class="keyword">about</span> <span class="keyword">the</span> UNIX <span class="property">version</span> <span class="keyword">to</span> Jim Gillogly (jim@rand.org).</span><br><span class="line"></span><br><span class="line">You are standing <span class="keyword">at</span> <span class="keyword">the</span> <span class="keyword">end</span> <span class="keyword">of</span> a road <span class="keyword">before</span> a small brick building.</span><br><span class="line">Around you <span class="keyword">is</span> a forest.  A small stream flows <span class="keyword">out of</span> <span class="keyword">the</span> building <span class="keyword">and</span></span><br><span class="line">down a gully.</span><br><span class="line">up</span><br><span class="line"></span><br><span class="line">You have walked up a hill, still <span class="keyword">in</span> <span class="keyword">the</span> forest.  The road slopes <span class="keyword">back</span></span><br><span class="line">down <span class="keyword">the</span> other side <span class="keyword">of</span> <span class="keyword">the</span> hill.  There <span class="keyword">is</span> a building <span class="keyword">in</span> <span class="keyword">the</span> distance.</span><br><span class="line">.......</span><br></pre></td></tr></table></figure>
<p>这个游戏可以通过安装 bsdgames 得到。<a href="http://wiki.linuxquestions.org/wiki/BSD_games" target="_blank" rel="external">bsdgames</a>包含了adventure和其它经典文字游戏，都可以尝试一下哦。</p>
<p>都在 /usr/games/ 目录里。</p>
<h3 id="更多更多有趣-amp-实用的命令👉http-www-commandlinefu-com"><a href="#更多更多有趣-amp-实用的命令👉http-www-commandlinefu-com" class="headerlink" title="更多更多有趣&amp;实用的命令👉http://www.commandlinefu.com"></a>更多更多有趣&amp;实用的命令👉<a href="http://www.commandlinefu.com" target="_blank" rel="external">http://www.commandlinefu.com</a></h3>
      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/">linux</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>










  
    <article id="post-wechat-app-and-wechat-subscription" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/15/wechat-app-and-wechat-subscription/" class="article-date">
  	<time datetime="2017-09-15T02:56:15.000Z" itemprop="datePublished">2017-09-15</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/15/wechat-app-and-wechat-subscription/">小程序绑定微信公众号之后的能力</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="公众号的连接能力"><a href="#公众号的连接能力" class="headerlink" title="公众号的连接能力"></a>公众号的连接能力</h2><h3 id="卡券-小程序打通"><a href="#卡券-小程序打通" class="headerlink" title="卡券-小程序打通"></a><a href="https://mp.weixin.qq.com/wiki?t=resource/res_main&amp;id=mp1499332673_Unm7V" target="_blank" rel="external">卡券-小程序打通</a></h3><p>1.小程序内领取卡券<br>2.小程序内查看卡券<br>3.小程序开卡组件<br>4.卡券内跳转小程序</p>
<h3 id="自定义菜单跳转小程序"><a href="#自定义菜单跳转小程序" class="headerlink" title="自定义菜单跳转小程序"></a><a href="https://mp.weixin.qq.com/wiki?t=resource/res_main&amp;id=mp1421141013" target="_blank" rel="external">自定义菜单跳转小程序</a></h3><h3 id="个性化菜单跳转小程序"><a href="#个性化菜单跳转小程序" class="headerlink" title="个性化菜单跳转小程序"></a><a href="https://mp.weixin.qq.com/wiki?t=resource/res_main&amp;id=mp1455782296" target="_blank" rel="external">个性化菜单跳转小程序</a></h3><h3 id="群发图文中插入小程序"><a href="#群发图文中插入小程序" class="headerlink" title="群发图文中插入小程序"></a><a href="https://mp.weixin.qq.com/wiki?t=resource/res_main&amp;id=mp1481187827_i0l21" target="_blank" rel="external">群发图文中插入小程序</a></h3><ul>
<li>小程序卡片跳转小程序，代码示例：</li>
<li><strong>小程序卡片的封面图链接，图片必须为1080*864像素</strong></li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">mp-miniprogram</span> <span class="attribute">data-miniprogram-appid</span>=<span class="value">"wx123123123"</span> <span class="attribute">data-miniprogram-path</span>=<span class="value">"pages/index/index"</span> <span class="attribute">data-miniprogram-title</span>=<span class="value">"小程序示例"</span> <span class="attribute">data-progarm-imageurl</span>=<span class="value">"http://mmbizqbic.cn/demo.jpg"</span>&gt;</span><span class="tag">&lt;/<span class="title">mp-miniprogram</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>文字跳转小程序，代码示例：</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">p</span>&gt;</span><span class="tag">&lt;<span class="title">a</span> <span class="attribute">data-miniprogram-appid</span>=<span class="value">"wx123123123"</span> <span class="attribute">data-miniprogram-path</span>=<span class="value">"pages/index"</span> <span class="attribute">href</span>=<span class="value">""</span>&gt;</span>点击文字跳转小程序<span class="tag">&lt;/<span class="title">a</span>&gt;</span><span class="tag">&lt;/<span class="title">p</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>图片跳转小程序，代码示例：</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">p</span>&gt;</span><span class="tag">&lt;<span class="title">a</span> <span class="attribute">data-miniprogram-appid</span>=<span class="value">"wx123123123"</span> <span class="attribute">data-miniprogram-path</span>=<span class="value">"pages/index"</span> <span class="attribute">href</span>=<span class="value">""</span>&gt;</span><span class="tag">&lt;<span class="title">img</span> <span class="attribute">data-src</span>=<span class="value">"http://mmbiz.qpic.cn/mmbiz_jpg/demo/0?wx_fmt=jpg"</span>&gt;</span><span class="tag">&lt;/<span class="title">a</span>&gt;</span><span class="tag">&lt;/<span class="title">p</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="可利用-unionId-让关联的公众号下发消息通知-模版消息跳转小程序"><a href="#可利用-unionId-让关联的公众号下发消息通知-模版消息跳转小程序" class="headerlink" title="可利用 unionId 让关联的公众号下发消息通知 模版消息跳转小程序"></a>可利用 unionId 让关联的公众号下发消息通知 <a href="https://mp.weixin.qq.com/wiki?t=resource/res_main&amp;id=mp1433751277" target="_blank" rel="external">模版消息跳转小程序</a></h3><h3 id="会员卡跳小程序"><a href="#会员卡跳小程序" class="headerlink" title="会员卡跳小程序"></a><a href="https://mp.weixin.qq.com/wiki?t=resource/res_main&amp;id=mp1451025283" target="_blank" rel="external">会员卡跳小程序</a></h3><h2 id="小程序中相关的场景值"><a href="#小程序中相关的场景值" class="headerlink" title="小程序中相关的场景值"></a>小程序中相关的场景值</h2><table>
<thead>
<tr>
<th>sence</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>1020</td>
<td>公众号 profile 页相关小程序列表</td>
</tr>
<tr>
<td>1035</td>
<td>公众号自定义菜单</td>
</tr>
<tr>
<td>1043</td>
<td>公众号模板消息</td>
</tr>
<tr>
<td>1058</td>
<td>公众号文章</td>
</tr>
<tr>
<td>1067</td>
<td>公众号文章广告</td>
</tr>
<tr>
<td>1074</td>
<td>公众号会话下发的小程序消息卡片</td>
</tr>
</tbody>
</table>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/微信小程序/">微信小程序</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>










  
    <article id="post-test-wechat-app" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/06/15/test-wechat-app/" class="article-date">
  	<time datetime="2017-06-15T08:30:03.000Z" itemprop="datePublished">2017-06-15</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/06/15/test-wechat-app/">小程序audio组件音频格式支持测试</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <table>
<thead>
<tr>
<th>音频文件类型</th>
<th>ios (iphone6s 10.3.2 wechat6.5.8)</th>
<th>android(sony Z3 6.0.1 wechat6.5.8)</th>
</tr>
</thead>
<tbody>
<tr>
<td>aac</td>
<td>ok</td>
<td>ok</td>
</tr>
<tr>
<td>mp3</td>
<td>ok</td>
<td>ok</td>
</tr>
<tr>
<td>wav</td>
<td>ok</td>
<td>ok</td>
</tr>
<tr>
<td>ac3</td>
<td>ok</td>
<td>\</td>
</tr>
<tr>
<td>amr</td>
<td>\</td>
<td>ok</td>
</tr>
<tr>
<td>flac</td>
<td>\</td>
<td>ok</td>
</tr>
<tr>
<td>ape</td>
<td>\</td>
<td>\</td>
</tr>
<tr>
<td>mmf</td>
<td>\</td>
<td>\</td>
</tr>
<tr>
<td>mp2</td>
<td>\</td>
<td>\</td>
</tr>
<tr>
<td>ogg</td>
<td>\</td>
<td>\</td>
</tr>
<tr>
<td>wma</td>
<td>\</td>
<td>\</td>
</tr>
<tr>
<td>wv</td>
<td>\</td>
<td>\</td>
</tr>
</tbody>
</table>
<ul>
<li><a href="http://cdn.zoeservers.com/testaudio/Don%27t%20Cry%20%28Original%29-Guns%20N%27%20Roses.aac" target="_blank" rel="external">测试文件-aac</a></li>
<li><a href="http://cdn.zoeservers.com/testaudio/Don%27t%20Cry%20%28Original%29-Guns%20N%27%20Roses.ac3" target="_blank" rel="external">测试文件-ac3</a></li>
<li><a href="http://cdn.zoeservers.com/testaudio/Don%27t%20Cry%20%28Original%29-Guns%20N%27%20Roses.amr" target="_blank" rel="external">测试文件-amr</a></li>
<li><a href="http://cdn.zoeservers.com/testaudio/Don%27t%20Cry%20%28Original%29-Guns%20N%27%20Roses.ape" target="_blank" rel="external">测试文件-ape</a></li>
<li><a href="http://cdn.zoeservers.com/testaudio/Don%27t%20Cry%20%28Original%29-Guns%20N%27%20Roses.flac" target="_blank" rel="external">测试文件-flac</a></li>
<li><a href="http://cdn.zoeservers.com/testaudio/Don%27t%20Cry%20%28Original%29-Guns%20N%27%20Roses.mmf" target="_blank" rel="external">测试文件-mmf</a></li>
<li><a href="http://cdn.zoeservers.com/testaudio/Don%27t%20Cry%20%28Original%29-Guns%20N%27%20Roses.mp2" target="_blank" rel="external">测试文件-mp2</a></li>
<li><a href="http://cdn.zoeservers.com/testaudio/Don%27t%20Cry%20%28Original%29-Guns%20N%27%20Roses.mp3" target="_blank" rel="external">测试文件-mp3</a></li>
<li><a href="http://cdn.zoeservers.com/testaudio/Don%27t%20Cry%20%28Original%29-Guns%20N%27%20Roses.ogg" target="_blank" rel="external">测试文件-ogg</a></li>
<li><a href="http://cdn.zoeservers.com/testaudio/Don%27t%20Cry%20%28Original%29-Guns%20N%27%20Roses.wav" target="_blank" rel="external">测试文件-wav</a></li>
<li><a href="http://cdn.zoeservers.com/testaudio/Don%27t%20Cry%20%28Original%29-Guns%20N%27%20Roses.wma" target="_blank" rel="external">测试文件-wma</a></li>
<li><a href="http://cdn.zoeservers.com/testaudio/Don%27t%20Cry%20%28Original%29-Guns%20N%27%20Roses.wv" target="_blank" rel="external">测试文件-wv</a></li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wechat-小程序/">wechat 小程序</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>










  
    <article id="post-something-interesting" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/05/26/something-interesting/" class="article-date">
  	<time datetime="2017-05-26T09:53:03.000Z" itemprop="datePublished">2017-05-26</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/05/26/something-interesting/">记录一些有趣的运用</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <ul>
<li>检测资源加载</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 桌面端适用于 chrome Firefox IE Opera （Edge和Safari不支持）</span></span><br><span class="line"><span class="comment">// 常见移动端 仅Android Webview, Firefox Mobile (Gecko)25.0+,Chrome for Android支持</span></span><br><span class="line"><span class="comment">// 所有css+js资源</span></span><br><span class="line"><span class="keyword">var</span> allResources = <span class="built_in">Array</span>.from(<span class="built_in">document</span>.getElementsByTagName(<span class="string">'script'</span>))  </span><br><span class="line">    .map(script =&gt; script.src)    </span><br><span class="line">    .concat(</span><br><span class="line">        <span class="built_in">Array</span>.from(<span class="built_in">document</span>.getElementsByTagName(<span class="string">'link'</span>))</span><br><span class="line">            .filter((link) =&gt; link.rel === <span class="string">'stylesheet'</span>)</span><br><span class="line">            .map((link) =&gt; link.href)</span><br><span class="line">    );</span><br><span class="line"><span class="comment">// 加载成功的css+js资源</span></span><br><span class="line"><span class="keyword">var</span> loadedResources = performance.getEntriesByType(<span class="string">'resource'</span>)  </span><br><span class="line">    .filter((res) =&gt; &#123;</span><br><span class="line">        <span class="keyword">var</span> url = res.name;</span><br><span class="line">        <span class="keyword">var</span> urlWithoutParam = url.split(<span class="string">'?'</span>)[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">return</span> [<span class="string">'script'</span>, <span class="string">'link'</span>].indexOf(res.initiatorType) !== -<span class="number">1</span> &amp;&amp;</span><br><span class="line">            [<span class="regexp">/\.css$/</span>, <span class="regexp">/\.js$/</span>].some((reg)  =&gt; reg.test(urlWithoutParam));</span><br><span class="line">    &#125;)).map((res) =&gt; res.name);</span><br><span class="line"><span class="comment">// 加载失败的css+js资源</span></span><br><span class="line"><span class="keyword">var</span> failedResources = allResources.filter((url) =&gt; loadedResources.indexOf(url) === -<span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>监听页面可见</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">document</span>.addEventListener(<span class="string">'visibilitychange'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">document</span>.title = <span class="built_in">document</span>.hidden ? <span class="string">'崩溃了，来看一下'</span> : <span class="string">'😈zoeying😈'</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<ul>
<li>字符画 附上一个生成字符画的网站<a href="http://patorjk.com/software/taag/" target="_blank" rel="external">👉Text Ascii Art Generator</a></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">`</span><br><span class="line"> ▄▄▄▄▄▄   ████▄ ▄███▄          ▄▄▄▄▄   ██   ▀▄    ▄          ▄  █ ▄█ </span><br><span class="line">▀   ▄▄▀   █   █ █▀   ▀        █     ▀▄ █ █    █  █          █   █ ██ </span><br><span class="line"> ▄▀▀   ▄▀ █   █ ██▄▄        ▄  ▀▀▀▀▄   █▄▄█    ▀█           ██▀▀█ ██ </span><br><span class="line"> ▀▀▀▀▀▀   ▀████ █▄   ▄▀      ▀▄▄▄▄▀    █  █    █            █   █ ▐█ </span><br><span class="line">                ▀███▀                     █  ▄▀                █   ▐ </span><br><span class="line">                                         █                    ▀      </span><br><span class="line">                                        ▀                            </span><br><span class="line">`</span>);</span><br></pre></td></tr></table></figure>
      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/javascript/">javascript</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>










  
    <article id="post-contenteditable-range-cursor-in-ios" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/05/26/contenteditable-range-cursor-in-ios/" class="article-date">
  	<time datetime="2017-05-26T02:39:03.000Z" itemprop="datePublished">2017-05-26</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/05/26/contenteditable-range-cursor-in-ios/">爬坑：WordPress-Editor-iOS 插入图片光标位置控制</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>WordPress-Editor-iOS 插入图片后光标位置没有移到图片后面咋办？</p>
</blockquote>
<p>问题如下（这是wordpress-ios 使用了<a href="https://github.com/wordpress-mobile/WordPress-Editor-iOS" target="_blank" rel="external">WordPress-Editor-iOS</a>作为富文本编辑器）：</p>
<p><img src="http://cdn.zoeservers.com/blog/contenteditable-range.gif" alt="WordPress-Editor-iOS 插入图片后光标位置没有移到图片后面咋办"></p>
<p>分析插入图片的代码（精简版）:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">insertImage</span>(<span class="params"> ...args </span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> sel=<span class="built_in">window</span>.getSelection()</span><br><span class="line">    <span class="keyword">var</span> range = sel.getRangeAt(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">var</span> img = <span class="built_in">document</span>.createElement(<span class="string">'img'</span>)</span><br><span class="line">    img.src=<span class="string">'https://ss0.bdstatic.com/5aV1bjqh_Q23odCf/static/superman/img/logo/bd_logo1_31bdc765.png'</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 实际代码在img外面包了一层span来做样式，这里直接用img类测试可以得到一样的效果</span></span><br><span class="line">    range.insertNode(img)</span><br><span class="line"></span><br><span class="line">    ...otherThings</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>上面代码中 insertNode 这个方法是在当前选区的开始处插入 node ， 那么如果我们手动将img加入选区，再将 range 的光标折叠（range.collapse()），使光标移动到最后，应该可以解决问题。</p>
<p>加入log，发现插入img之后，它是包含在选区内的</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(range.collapsed,range.startOffset,range.endOffset)</span><br><span class="line">range.insertNode(img)</span><br><span class="line"><span class="built_in">console</span>.log(range.collapsed,range.startOffset,range.endOffset)</span><br></pre></td></tr></table></figure>
<p>那么这里直接执行 range.collapse() ， 可以看到在chrome中已经可以达到效果<a href="http://zoeservers.com/example/range.html" target="_blank" rel="external">👉👉👉例子👈👈👈</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">range.insertNode(img)</span><br><span class="line">range.collapse()</span><br></pre></td></tr></table></figure>
<p>然而，app中仍然不起作用，甚至会在插入第一张图片时失去焦点，在 stackoverflow 中找到新建选区的方式去选中：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">range.insertNode(img)</span><br><span class="line">range.collapse()</span><br><span class="line"></span><br><span class="line"><span class="comment">//Create a range (a range is a like the selection but invisible)</span></span><br><span class="line"><span class="keyword">var</span> newrange = <span class="built_in">document</span>.createRange();</span><br><span class="line"><span class="comment">//Select the entire contents of the element with the newrange</span></span><br><span class="line">newrange.setStart(img,<span class="number">0</span>);</span><br><span class="line"><span class="comment">//collapse the range to the end point. false means collapse to end rather than the start</span></span><br><span class="line">newrange.collapse(<span class="literal">false</span>);</span><br><span class="line"><span class="comment">//get the selection object (allows you to change selection)</span></span><br><span class="line"><span class="keyword">var</span> selection = <span class="built_in">window</span>.getSelection();</span><br><span class="line"><span class="comment">//remove any selections already made</span></span><br><span class="line">selection.removeAllRanges();</span><br><span class="line">selection.addRange(newrange);</span><br></pre></td></tr></table></figure>
<p>rang 还有一个 selectNodeContents 方法可以用来选中整个编辑区域，折叠后可以讲光标移动到最后</p>
<p>新建选区后，app中依然无解–光标会在插入图片后，从图片后面跳到图片前面，这时候按一下键盘中的删除，图片神奇的被删掉了 = =|||</p>
<p>如果，这是WKwebview的bug 那我……也只能忍了</p>
<p>尝试在图片后面加一个 br/span 然后选中 br/span 去改变光标位置，测试完败……</p>
<p>那么，假设，这是span这个节点的问题，换做是textNode…..</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">range.deleteContents();</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> text = <span class="built_in">document</span>.createTextNode(<span class="string">'描述这张图片~'</span>)</span><br><span class="line">range.insertNode(text)</span><br><span class="line">range.insertNode(img)</span><br><span class="line">range.collapse()</span><br><span class="line"></span><br><span class="line"><span class="comment">//Create a range (a range is a like the selection but invisible)</span></span><br><span class="line"><span class="keyword">var</span> newrange = <span class="built_in">document</span>.createRange();</span><br><span class="line"><span class="comment">//Select the entire contents of the element with the newrange</span></span><br><span class="line">newrange.setStart(img,<span class="number">0</span>);</span><br><span class="line"><span class="comment">//collapse the range to the end point. false means collapse to end rather than the start</span></span><br><span class="line">newrange.collapse(<span class="literal">false</span>);</span><br><span class="line"><span class="comment">//get the selection object (allows you to change selection)</span></span><br><span class="line"><span class="keyword">var</span> selection = <span class="built_in">window</span>.getSelection();</span><br><span class="line"><span class="comment">//remove any selections already made</span></span><br><span class="line">selection.removeAllRanges();</span><br><span class="line">selection.addRange(newrange);</span><br></pre></td></tr></table></figure>
<p>如下图（自家app），只能曲线救国了</p>
<p><img src="http://cdn.zoeservers.com/00f93ddce9b2a40ea2e4f2cd5a975a93.gif" alt="在图片后加入textNode并选中"></p>
<p>参考：</p>
<p><a href="https://developer.mozilla.org/en-US/docs/Web/API/range" target="_blank" rel="external">MDN &gt; web apis &gt; range</a><br><a href="http://www.zhangxinxu.com/wordpress/2011/04/js-range-html%E6%96%87%E6%A1%A3%E6%96%87%E5%AD%97%E5%86%85%E5%AE%B9%E9%80%89%E4%B8%AD%E3%80%81%E5%BA%93%E5%8F%8A%E5%BA%94%E7%94%A8%E4%BB%8B%E7%BB%8D/" target="_blank" rel="external">JS Range HTML文档/文字内容选中、库及应用介绍</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/hybird/">hybird</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>










  
    <article id="post-zhihu-spider" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/05/23/zhihu-spider/" class="article-date">
  	<time datetime="2017-05-23T06:38:50.000Z" itemprop="datePublished">2017-05-23</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/05/23/zhihu-spider/">phantomjs nodejs 爬数据</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>运营童鞋想要对知乎的相关数据做分析</p>
</blockquote>
<ul>
<li>抓取第一波数据花费 3 小时左右</li>
<li>优化数据&amp;改良代码  2 小时左右</li>
<li>抓取第二波数据     10 分钟</li>
</ul>
<p>需要抓取数据的页面有两个</p>
<ol>
<li>搜索<strong>结果页面</strong>（问题列表以及该问题的高票回答列表）</li>
<li>1中可得到的<strong>问题页面</strong>内<strong>关注量</strong>以及<strong>浏览量</strong></li>
</ol>
<p>界面1 知乎中加载更多用的是服务端渲染，直接返回html字符串，要解析这部分数据呢需要结合界面中的标签，用正则去提取，想到这里，反正界面已经在眼前何不直接操作dom取数据呢？</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">document</span>.querySelector();</span><br></pre></td></tr></table></figure>
<p>于是在这一步中只需要会打开控制台，会找dom class的关系，可轻易得到问题的列表 </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[&#123;</span><br><span class="line">	<span class="string">"title"</span>: <span class="string">"牙齿矫正对个人外貌变化有多大影响？"</span>,</span><br><span class="line">	<span class="string">"topicUrl"</span>: <span class="string">"https://www.zhihu.com/question/49519516"</span>,</span><br><span class="line">	<span class="string">"commentAmount"</span>: <span class="string">"483 条评论"</span>,</span><br><span class="line">	<span class="string">"vote"</span>: <span class="string">"1223"</span>,</span><br><span class="line">	<span class="string">"author"</span>: <span class="string">"Vivian"</span>,</span><br><span class="line">	<span class="string">"authorHome"</span>: <span class="string">"https://www.zhihu.com/people/vivian-74-91"</span>,</span><br><span class="line">	<span class="string">"badge"</span>: <span class="literal">null</span>,</span><br><span class="line">	<span class="string">"badgeSummary"</span>: <span class="literal">null</span>,</span><br><span class="line">	<span class="string">"bio"</span>: <span class="string">"一无所是的空想者"</span>,</span><br><span class="line">	<span class="string">"answerDigest"</span>: <span class="string">"用本人的真实照片来回答这个提问照片记录了整牙前后的完整变化,包括牙齿和脸型,29岁才开始矫正,历时一年半,期间经历了戴着牙套拍婚纱照,举办婚礼,旅行…... 什么感觉?要上天啊哈哈哈哈哈~所以,可能angelababy 真的只是做了牙齿矫正而已!一直觉得自己牙齿不…显示全部"</span>,</span><br><span class="line">	<span class="string">"answerUrl"</span>: <span class="string">"https://www.zhihu.com/question/49519516/answer/137252689"</span>,</span><br><span class="line">	<span class="string">"publishTime"</span>: <span class="string">"2016-12-23"</span>,</span><br><span class="line">	<span class="string">"updateTime"</span>: <span class="string">"2017-01-02"</span>,</span><br><span class="line">&#125;,</span><br><span class="line">...others</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>之前看过许多phantomjs的应用文章，依靠构建一个浏览器运行环境模拟用户行为，可以做自动化测试，ui截图，爬虫等。</p>
<p>界面2 是根据<a href="https://www.zhihu.com/question/49519516" target="_blank" rel="external">topicUrl</a>在问题详情页抓取<strong>关注者（人数）</strong>，<strong>被浏览（次数）</strong>以及问题所属的tag，这一步就需要phantomjs来跑循环了。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">phantomjs fetchAnswerjs <span class="number">0</span> <span class="number">150</span></span><br></pre></td></tr></table></figure>
<p>phantomjs fetchAnswerjs 0( arg[1] start_index ) 150( arg[2] times )</p>
<p>以下是简要流程</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// page用来打开指定url并执行数据抓取</span></span><br><span class="line"><span class="keyword">var</span> page = <span class="built_in">require</span>(<span class="string">'webpage'</span>).create(), </span><br><span class="line"><span class="comment">// 读取上一步得到的列表.json数据 根据topicUrl抓取页面</span></span><br><span class="line">    fs = <span class="built_in">require</span>(<span class="string">"fs"</span>),</span><br><span class="line"><span class="comment">// system.args [array] 取terninal传递的参数 </span></span><br><span class="line"><span class="comment">// 使用了两个参数（ start_index , times ）来控制整个循环  </span></span><br><span class="line">    system = <span class="built_in">require</span>(<span class="string">'system'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// function startFetch( url )</span></span><br><span class="line">	page.open(  url , <span class="function"><span class="keyword">function</span> (<span class="params">status</span>) </span>&#123;</span><br><span class="line">	    <span class="keyword">if</span> (status !== <span class="string">'success'</span>) &#123;</span><br><span class="line">	        <span class="built_in">console</span>.log(<span class="string">'FAIL to load the address'</span>);</span><br><span class="line">	    &#125;<span class="keyword">else</span>&#123;    	</span><br><span class="line">	    	</span><br><span class="line">		    <span class="keyword">var</span> data = page.evaluate(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="comment">// document.querySelector( everything );</span></span><br><span class="line">                <span class="keyword">return</span> &#123; ...data &#125;</span><br><span class="line">		    &#125;);</span><br><span class="line">            fullData[index] = &#123; ...fullData[index] , data &#125;</span><br><span class="line">            fs.write( filePathName , <span class="built_in">JSON</span>.stringify(fullData) );</span><br><span class="line">			afterFetch();</span><br><span class="line">			<span class="keyword">return</span> ;</span><br><span class="line">	    &#125;</span><br><span class="line"></span><br><span class="line">	&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">afterFetch</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="comment">// compare current_index with start_index and times</span></span><br><span class="line">        <span class="comment">// try fullData[current_index]</span></span><br><span class="line">        start( fullData[current_index + <span class="number">1</span>] ) or phantom.exit();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// phantom 错误处理 常遇到界面404的情况 可以根据报错情况跳过</span></span><br><span class="line">phantom.onError = <span class="function"><span class="keyword">function</span>(<span class="params">msg, trace</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> msgStack = [<span class="string">'PHANTOM ERROR: '</span> + msg];</span><br><span class="line">    <span class="keyword">if</span> (trace &amp;&amp; trace.length) &#123;</span><br><span class="line">        msgStack.push(<span class="string">'TRACE:'</span>);</span><br><span class="line">        trace.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">t</span>) </span>&#123;</span><br><span class="line">            msgStack.push(<span class="string">' -&gt; '</span> + (t.file || t.sourceURL) + <span class="string">': '</span> + t.line + (t.function ? <span class="string">' (in function '</span> + t.function +<span class="string">')'</span> : <span class="string">''</span>));</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">console</span>.error(msgStack.join(<span class="string">'\n'</span>));</span><br><span class="line">    phantom.exit(<span class="number">1</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><img src="http://cdn.zoeservers.com/zhihu.gif" alt="运行时的截图"></p>
<p>要的数据都已经抓好啦，下一步用nodejs改一下标题，转换成csv文件方便运营同学用excel做分析，其实改标题也可以在phantomjs里面完成。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 也是用到 fs</span></span><br><span class="line"><span class="keyword">let</span> dataList = <span class="built_in">require</span>(<span class="string">'./afterFormat.json'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> result = dataList.map( item =&gt; dealData(item) ) </span><br><span class="line"></span><br><span class="line">fs.writeFile( filetitle , <span class="built_in">JSON</span>.stringify( result ) , <span class="string">'utf8'</span> , <span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'The file has been saved!'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><img src="http://cdn.zoeservers.com/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20170523162357.png" alt="导出的文件截图"></p>
<p>打算丢给运营同学用神箭手自己去玩 : )</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>










  
    <article id="post-interview-questions" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/04/12/interview-questions/" class="article-date">
  	<time datetime="2017-04-12T09:32:31.000Z" itemprop="datePublished">2017-04-12</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/04/12/interview-questions/">考验基础的面试题</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>偶然看到一篇解析面试题目的文章，考验了javascript的函数，变量，属性，原型对象，优先级等要点。</p>
<p>有同行认为这在实战中没有用到，不用理解，甚至认为是脑筋急转弯，我并不认同这样的观点，在实际调试，理解程序的过程中，对于这些写法的误解或是一知半解极易把自己带入坑。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Foo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    getName = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; <span class="built_in">console</span>.log(<span class="number">1</span>); &#125;;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line">Foo.getName = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; <span class="built_in">console</span>.log(<span class="number">2</span>);&#125;;</span><br><span class="line">Foo.prototype.getName = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; <span class="built_in">console</span>.log(<span class="number">3</span>);&#125;;</span><br><span class="line"><span class="keyword">var</span> getName = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; <span class="built_in">console</span>.log(<span class="number">4</span>);&#125;;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getName</span>(<span class="params"></span>) </span>&#123; <span class="built_in">console</span>.log(<span class="number">5</span>);&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//请写出以下输出结果：</span></span><br><span class="line">Foo.getName();</span><br><span class="line"><span class="comment">// 2 访问公有属性</span></span><br><span class="line">getName();</span><br><span class="line"><span class="comment">// 4 window.getName()</span></span><br><span class="line">Foo().getName();</span><br><span class="line"><span class="comment">// 1 window.getName()</span></span><br><span class="line">getName();</span><br><span class="line"><span class="comment">// 1 window.getName()</span></span><br><span class="line"><span class="keyword">new</span> Foo.getName();</span><br><span class="line"><span class="comment">// 2 访问公有属性</span></span><br><span class="line"><span class="keyword">new</span> Foo().getName();</span><br><span class="line"><span class="comment">// 1 (new Foo()).getName()</span></span><br><span class="line"><span class="keyword">new</span> <span class="keyword">new</span> Foo().getName();</span><br><span class="line"><span class="comment">// 3 new (new Foo()).getName()</span></span><br></pre></td></tr></table></figure>
<p><a href="http://www.codeceo.com/article/one-javascript-interview.html" target="_blank" rel="external">原文中有详细解释</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/javascript/">javascript</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>










  
    <article id="post-redpack-activity" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/04/07/redpack-activity/" class="article-date">
  	<time datetime="2017-04-07T10:25:37.000Z" itemprop="datePublished">2017-04-07</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/04/07/redpack-activity/">红包活动</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="年前的红包活动总结"><a href="#年前的红包活动总结" class="headerlink" title="年前的红包活动总结"></a>年前的红包活动总结</h2><ul>
<li>公众号的粉丝量并不阻碍有“利”内容在微信中的传播力</li>
<li>羊毛党是非常可怕的</li>
<li>缺少压力测试</li>
<li>尽可能的静态化能大大减少服务器的压力</li>
<li>尽可能的记录活动数据</li>
<li>出错后的数据回滚</li>
<li>顺手做的统计功能很实用</li>
</ul>
<p>2017年新年的前一周，来了个回馈新老用户发红包的活动，新用户需要关注公众号，老用户点击领取按钮后用公众号下发红包。</p>
<p>这次活动仅在公众号文章中做了宣传，并没有在其它渠道做推广，然而似乎被羊毛党盯上，随着时间的推移，发出红包的速度像一个指数函数，大约6小时后随机红包被薅光，21:20 分左右迎来了一个小高潮，并且发完后的几个小时访问量还在持续增加，第三天才恢复正常。当日的PV是平时的150多倍，领取红包的用户中新用户占98%。</p>
<p>发红包的规则：</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>名额</th>
<th>方式</th>
<th>金额（元）</th>
<th>随机概率占比</th>
</tr>
</thead>
<tbody>
<tr>
<td>指定老用户</td>
<td>100</td>
<td>固定</td>
<td>6.66</td>
<td>元</td>
</tr>
<tr>
<td>普通用户</td>
<td>20</td>
<td>随机</td>
<td>5~10</td>
<td>36/10000</td>
</tr>
<tr>
<td>普通用户</td>
<td>480</td>
<td>随机</td>
<td>2~5</td>
<td>873/10000</td>
</tr>
<tr>
<td>普通用户</td>
<td>5000</td>
<td>随机</td>
<td>1~2</td>
<td>元</td>
</tr>
</tbody>
</table>
<p>目前活动已下架，以下是业务代码。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">// 活动：新年红包 zoe@20170116 </span></span><br><span class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">happy_new_year</span><span class="params">(Request <span class="variable">$request</span>)</span> </span>&#123;</span><br><span class="line">	<span class="variable">$WechatJSMgr</span> = <span class="keyword">new</span> WechatJSMgr();</span><br><span class="line">	<span class="variable">$ua</span>= <span class="variable">$WechatJSMgr</span>-&gt;checkBrowser(<span class="variable">$request</span>);</span><br><span class="line">	<span class="variable">$err_msg</span> = <span class="string">''</span> ;</span><br><span class="line">	<span class="comment">// 是否关注了公众号，0未关注，1关注</span></span><br><span class="line">	<span class="variable">$subscription</span> = <span class="number">0</span>; </span><br><span class="line">	<span class="variable">$has_gift</span>     = <span class="number">0</span> ;</span><br><span class="line">	<span class="variable">$user</span> 		  = <span class="keyword">false</span> ;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="variable">$ua</span>==<span class="string">"wechat"</span>)&#123;</span><br><span class="line">		<span class="variable">$user</span> = @session(<span class="string">'wechat_user'</span>) ;</span><br><span class="line">		<span class="variable">$open_id</span> = <span class="variable">$user</span>[<span class="string">'openid'</span>];</span><br><span class="line">		<span class="keyword">if</span> ( !<span class="variable">$user</span> || <span class="keyword">empty</span>(<span class="variable">$open_id</span>) )<span class="keyword">return</span> redirect(<span class="string">'/wechat/auth_rate?url='</span>.urlencode(<span class="variable">$request</span>-&gt;getRequestUri()));</span><br><span class="line"></span><br><span class="line">		<span class="variable">$sendMsgMgr</span> = <span class="keyword">new</span> sendMsgMgr();</span><br><span class="line">		<span class="variable">$chk_wx_user</span> = <span class="variable">$sendMsgMgr</span>-&gt;chk_wx_user(<span class="variable">$open_id</span>);</span><br><span class="line">		<span class="keyword">if</span> ( <span class="variable">$chk_wx_user</span> )&#123;</span><br><span class="line">			<span class="variable">$subscription</span> = <span class="number">1</span> ;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 判断是否领过奖</span></span><br><span class="line">		<span class="variable">$gift</span> = ActivityHappyNewYearModel::where(<span class="string">'open_id'</span>, <span class="variable">$open_id</span> )-&gt;first();</span><br><span class="line">		<span class="keyword">if</span> ( <span class="keyword">empty</span>(<span class="variable">$gift</span>) )&#123;</span><br><span class="line">			<span class="variable">$gift</span> = <span class="keyword">new</span> ActivityHappyNewYearModel();</span><br><span class="line">			<span class="variable">$gift</span>-&gt;open_id = <span class="variable">$open_id</span> ;</span><br><span class="line">			<span class="variable">$gift</span>-&gt;user_name = <span class="variable">$user</span>[<span class="string">'nickname'</span>] ;</span><br><span class="line">			<span class="variable">$rs</span> = <span class="variable">$gift</span>-&gt;save();</span><br><span class="line">		&#125;<span class="keyword">else</span> <span class="keyword">if</span> ( <span class="variable">$gift</span>-&gt;status == <span class="number">1</span> )&#123;</span><br><span class="line">			<span class="comment">// 礼物已领取</span></span><br><span class="line">			<span class="variable">$has_gift</span> = <span class="number">1</span> ;		</span><br><span class="line">		&#125;</span><br><span class="line">           </span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="variable">$err_msg</span> = <span class="string">"活动需要在微信中打开 &gt;...&lt; "</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="variable">$wechatJSDK</span>  = <span class="variable">$WechatJSMgr</span>-&gt;get_JS_config(<span class="variable">$request</span>-&gt;getUri());</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> view(<span class="string">'activity.happy_new_year'</span>,[</span><br><span class="line">			<span class="string">'user'</span>		  =&gt; json_encode( <span class="variable">$user</span> ) ,</span><br><span class="line">			<span class="string">'wechatJSDK'</span>  =&gt; <span class="variable">$wechatJSDK</span>[<span class="string">'data'</span>][<span class="string">'config'</span>] ,</span><br><span class="line">			<span class="string">'err_msg'</span>     =&gt; <span class="variable">$err_msg</span> ,</span><br><span class="line">			<span class="string">'has_gift'</span>    =&gt; <span class="variable">$has_gift</span> ,</span><br><span class="line">			<span class="string">'subscription'</span>=&gt; <span class="variable">$subscription</span> ,</span><br><span class="line">			<span class="string">'from_subscribe'</span>=&gt; <span class="variable">$request</span>-&gt;has(<span class="string">'from_subscribe'</span>) ? <span class="number">1</span> : <span class="number">0</span> ,</span><br><span class="line">			<span class="string">'webstatic'</span> =&gt; <span class="string">'https://webstatic.xxxxx.com/activity/happy_new_year/'</span> , <span class="comment">// CDN静态资源地址</span></span><br><span class="line">		]);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 新年活动 step2 发红包</span></span><br><span class="line"><span class="comment">// 微信接口文档 https://pay.weixin.qq.com/wiki/doc/api/tools/cash_coupon.php?chapter=13_4&amp;index=3</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">happy_new_year_gift</span><span class="params">(Request <span class="variable">$request</span>)</span> </span>&#123;</span><br><span class="line">	DB::beginTransaction();</span><br><span class="line">	<span class="keyword">try</span>&#123;</span><br><span class="line">		<span class="comment">// 根据open_id 来发</span></span><br><span class="line">		<span class="variable">$open_id</span> = <span class="variable">$request</span>-&gt;input(<span class="string">'open_id'</span>);</span><br><span class="line">		<span class="variable">$err_msg</span> = <span class="string">''</span>;</span><br><span class="line">		<span class="variable">$err_code</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> ( !<span class="variable">$open_id</span> )&#123;</span><br><span class="line">			<span class="variable">$err_msg</span> = <span class="string">'请在微信中打开~'</span> ;</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="comment">// 判断是否领过奖</span></span><br><span class="line">			<span class="variable">$gift</span> = ActivityHappyNewYearModel::where(<span class="string">'open_id'</span>, <span class="variable">$open_id</span> )-&gt;first();</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> ( !<span class="keyword">empty</span>(<span class="variable">$gift</span>) &amp;&amp; <span class="variable">$gift</span>-&gt;status == <span class="number">1</span> )&#123;</span><br><span class="line">				<span class="comment">// 礼物已领取</span></span><br><span class="line">				<span class="variable">$err_msg</span> = <span class="string">"好看的你已经领过红包了~"</span> ;</span><br><span class="line">				<span class="variable">$err_code</span> = <span class="number">99</span> ;</span><br><span class="line">			&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">				<span class="comment">// 发红包</span></span><br><span class="line">				<span class="keyword">if</span> ( <span class="keyword">empty</span>(<span class="variable">$gift</span>) )&#123;</span><br><span class="line">					<span class="variable">$gift</span> = <span class="keyword">new</span> ActivityHappyNewYearModel();</span><br><span class="line">					<span class="variable">$gift</span>-&gt;open_id = <span class="variable">$open_id</span> ;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="variable">$money</span> = <span class="number">0</span> ;</span><br><span class="line">				</span><br><span class="line">				<span class="comment">// 100位老客户给6.66 					</span></span><br><span class="line">				<span class="keyword">if</span> ( <span class="variable">$gift</span>-&gt;isSeedUser() )&#123;</span><br><span class="line">					 <span class="variable">$money</span> = <span class="number">666</span> ;</span><br><span class="line">				&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"></span><br><span class="line">					 <span class="variable">$money</span> = <span class="variable">$this</span>-&gt;happy_new_year_money();</span><br><span class="line">					 <span class="keyword">if</span> ( <span class="variable">$money</span> == <span class="number">0</span>) &#123;</span><br><span class="line">						 <span class="variable">$err_msg</span> = <span class="string">'红包已经被抢完啦&lt;br&gt;感谢您持续关注&lt;br&gt;健康就是最大的财富'</span>;</span><br><span class="line">					 &#125;</span><br><span class="line">					 </span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span> ( <span class="variable">$money</span> )&#123;</span><br><span class="line">					 <span class="keyword">if</span> ( !<span class="variable">$gift</span>-&gt;gift_id ) <span class="variable">$gift</span>-&gt;save() ;</span><br><span class="line"></span><br><span class="line">					<span class="comment">// 补齐giftid 4位数</span></span><br><span class="line">					<span class="variable">$gift_id_paddding</span> = substr(strval(<span class="variable">$gift</span>-&gt;gift_id + <span class="number">10000</span>),<span class="number">1</span>,<span class="number">4</span>) ;</span><br><span class="line">					<span class="variable">$mch_id</span>     = config(<span class="string">'wechat.mch_id'</span>) ;</span><br><span class="line">					<span class="variable">$mch_billno</span> = <span class="variable">$mch_id</span> . date(<span class="string">'YmdHis'</span>) . <span class="variable">$gift_id_paddding</span> ;</span><br><span class="line"></span><br><span class="line">					<span class="variable">$business</span>  = <span class="keyword">new</span> Business( config(<span class="string">'wechat.app_id'</span>),config(<span class="string">'wechat.secret'</span>),config(<span class="string">'wechat.mch_id'</span>),config(<span class="string">'wechat.mch_key'</span>));</span><br><span class="line"></span><br><span class="line">					<span class="variable">$cert_path</span> = dirname(<span class="keyword">__FILE__</span>) .<span class="string">'/../../../../'</span>.config(<span class="string">'wechat.cert_path'</span>);</span><br><span class="line">					<span class="variable">$cert_path</span> = realpath(<span class="variable">$cert_path</span>) ;</span><br><span class="line"></span><br><span class="line">					<span class="variable">$key_path</span> = dirname(<span class="keyword">__FILE__</span>) .<span class="string">'/../../../../'</span>.config(<span class="string">'wechat.key_path'</span>);</span><br><span class="line">					<span class="variable">$key_path</span> = realpath(<span class="variable">$key_path</span>) ;</span><br><span class="line"></span><br><span class="line">					<span class="variable">$business</span>-&gt;setClientCert( <span class="variable">$cert_path</span> );</span><br><span class="line">					<span class="variable">$business</span>-&gt;setClientKey( <span class="variable">$key_path</span> );</span><br><span class="line"></span><br><span class="line">					<span class="variable">$luckyMoney</span> = <span class="keyword">new</span> LuckMoney(<span class="variable">$business</span>);</span><br><span class="line">					<span class="variable">$luckyMoneyData</span> = [</span><br><span class="line">						<span class="string">'mch_billno'</span>       =&gt; <span class="variable">$mch_billno</span> , <span class="comment">//mch_id+yyyymmdd+10位</span></span><br><span class="line">						<span class="string">'send_name'</span>        =&gt; <span class="string">'send_name'</span>,</span><br><span class="line">						<span class="string">'re_openid'</span>        =&gt; <span class="variable">$open_id</span> ,</span><br><span class="line">						<span class="string">'total_num'</span>        =&gt; <span class="number">1</span> ,  			<span class="comment">//固定为1，可不传</span></span><br><span class="line">						<span class="string">'total_amount'</span>     =&gt; <span class="variable">$money</span> ,      <span class="comment">//单位为分</span></span><br><span class="line">						<span class="string">'wishing'</span>          =&gt; <span class="string">'wishing'</span>,</span><br><span class="line">						<span class="string">'act_name'</span>         =&gt; <span class="string">'act_name'</span>,</span><br><span class="line">						<span class="string">'remark'</span>           =&gt; <span class="string">'remark'</span>,</span><br><span class="line">					];</span><br><span class="line"></span><br><span class="line">					<span class="variable">$result</span> = <span class="variable">$luckyMoney</span>-&gt;sendNormal(<span class="variable">$luckyMoneyData</span>);</span><br><span class="line"></span><br><span class="line">					<span class="comment">// 成功后修改数据库</span></span><br><span class="line">					<span class="keyword">if</span> ( <span class="variable">$result</span>[<span class="string">'return_code'</span>] == <span class="string">"SUCCESS"</span> &amp;&amp; <span class="variable">$result</span>[<span class="string">'result_code'</span>] == <span class="string">"SUCCESS"</span> )&#123;</span><br><span class="line"></span><br><span class="line">						<span class="variable">$gift</span>-&gt;amount 		 = <span class="variable">$result</span>[<span class="string">'total_amount'</span>] ;</span><br><span class="line">						<span class="variable">$gift</span>-&gt;mch_billno    = <span class="variable">$result</span>[<span class="string">'mch_billno'</span>];</span><br><span class="line">						<span class="variable">$gift</span>-&gt;wechat_billno = <span class="variable">$result</span>[<span class="string">'send_listid'</span>];</span><br><span class="line"></span><br><span class="line">						<span class="variable">$user</span> = <span class="variable">$gift</span>-&gt;user ;</span><br><span class="line">						<span class="keyword">if</span> ( <span class="variable">$user</span> &amp;&amp; <span class="keyword">isset</span>( <span class="variable">$user</span> ) )&#123;</span><br><span class="line">							<span class="variable">$gift</span>-&gt;user_name = <span class="variable">$user</span>-&gt;real_name ? <span class="variable">$user</span>-&gt;real_name : <span class="variable">$user</span>-&gt;nickname ;</span><br><span class="line">							<span class="variable">$gift</span>-&gt;mobile 	 = <span class="variable">$user</span>-&gt;mobile ;</span><br><span class="line">						&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">							<span class="variable">$gift</span>-&gt;remark    = <span class="string">'未注册用户'</span>;</span><br><span class="line">						&#125;</span><br><span class="line">						<span class="variable">$gift</span>-&gt;invitation  = <span class="variable">$request</span>-&gt;input(<span class="string">'invitation'</span>) || <span class="string">''</span>;</span><br><span class="line">						<span class="variable">$gift</span>-&gt;firing_time = Carbon::now(); </span><br><span class="line">						<span class="variable">$gift</span>-&gt;status = <span class="number">1</span> ;</span><br><span class="line"></span><br><span class="line">					&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"></span><br><span class="line">						<span class="variable">$gift</span>-&gt;status = <span class="number">99</span> ;</span><br><span class="line">						<span class="comment">// 失败时返回失败信息，并将gift的状态标记为99异常</span></span><br><span class="line">						<span class="variable">$err_msg</span> = <span class="keyword">isset</span>(<span class="variable">$result</span>[<span class="string">'return_msg'</span>]) ? </span><br><span class="line">								<span class="string">'微信接口返回：'</span>.<span class="variable">$result</span>[<span class="string">'return_msg'</span>] :</span><br><span class="line">								<span class="keyword">isset</span>(<span class="variable">$result</span>[<span class="string">'err_code'</span>]) || <span class="keyword">isset</span>(<span class="variable">$result</span>[<span class="string">'err_code_des'</span>]) ?</span><br><span class="line">								<span class="string">'微信业务接口返回：'</span>.(<span class="keyword">isset</span>(<span class="variable">$result</span>[<span class="string">'err_code'</span>]) ? <span class="variable">$result</span>[<span class="string">'err_code'</span>] : <span class="string">''</span> ).(<span class="keyword">isset</span>(<span class="variable">$result</span>[<span class="string">'err_code_des'</span>]) ? <span class="variable">$result</span>[<span class="string">'err_code_des'</span>] : <span class="string">''</span> ) :</span><br><span class="line">								<span class="string">'微信接口调用失败'</span> ;</span><br><span class="line">						<span class="variable">$gift</span>-&gt;remark = <span class="variable">$err_msg</span> ;</span><br><span class="line">						<span class="comment">// 返回给用户的提示</span></span><br><span class="line">						<span class="variable">$err_msg</span> = <span class="string">'红包已经被抢完啦&lt;br&gt;感谢您持续关注&lt;br&gt;健康就是最大的财富'</span>;</span><br><span class="line">					&#125;</span><br><span class="line"></span><br><span class="line">					<span class="keyword">if</span> ( <span class="variable">$gift</span>-&gt;save() == <span class="keyword">false</span> ) <span class="keyword">throw</span> <span class="keyword">new</span> \<span class="keyword">Exception</span>(<span class="string">'新年红包活动数据保存失败'</span>);</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		DB::commit();</span><br><span class="line">		<span class="keyword">if</span> ( <span class="variable">$err_msg</span> )&#123;</span><br><span class="line">			<span class="keyword">return</span> json_encode([</span><br><span class="line">				<span class="string">'code'</span> =&gt; <span class="variable">$err_code</span> ? <span class="variable">$err_code</span> : <span class="number">90001</span> ,</span><br><span class="line">				<span class="string">'errmsg'</span> =&gt; <span class="variable">$err_msg</span> ,</span><br><span class="line">				<span class="string">'data'</span> =&gt; []</span><br><span class="line">			],JSON_UNESCAPED_UNICODE);</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="keyword">return</span> json_encode([</span><br><span class="line">				<span class="string">'code'</span> =&gt; <span class="number">0</span> ,</span><br><span class="line">				<span class="string">'data'</span> =&gt; []</span><br><span class="line">			],JSON_UNESCAPED_UNICODE);</span><br><span class="line">		&#125;</span><br><span class="line">    &#125;<span class="keyword">catch</span>(\<span class="keyword">Exception</span> <span class="variable">$e</span>)&#123;</span><br><span class="line">	    	DB::rollBack();</span><br><span class="line"></span><br><span class="line">			<span class="variable">$open_id</span> = <span class="variable">$request</span>-&gt;has(<span class="string">'open_id'</span>) ? <span class="variable">$request</span>-&gt;open_id : <span class="string">'no open_id'</span>;</span><br><span class="line"></span><br><span class="line">			Rizhi::one( <span class="string">'happy_new_year_gift'</span> , <span class="variable">$open_id</span>  , <span class="keyword">array</span>(<span class="string">'Message'</span>=&gt;<span class="variable">$e</span>-&gt;getMessage(),<span class="string">'TraceAsString'</span>=&gt;<span class="variable">$e</span>-&gt;getTraceAsString()) );</span><br><span class="line"></span><br><span class="line">			<span class="keyword">return</span> json_encode([</span><br><span class="line">				<span class="string">'code'</span> =&gt; <span class="number">90001</span> ,</span><br><span class="line">				<span class="string">'errmsg'</span> =&gt; <span class="string">'红包已经被抢完啦&lt;br&gt;感谢您持续关注&lt;br&gt;健康就是最大的财富'</span> ,</span><br><span class="line">				<span class="string">'data'</span> =&gt; []</span><br><span class="line">			],JSON_UNESCAPED_UNICODE);</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">happy_new_year_money</span> <span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="comment">// 20   位普通用户随机 5~10  元 概率占比   36/10000</span></span><br><span class="line">	<span class="comment">// 480  位普通用户随机 2~5   元 概率占比  873/10000</span></span><br><span class="line">	<span class="comment">// 5000 位普通用户随机 1~2   元 概率占比 9091/10000</span></span><br><span class="line">	<span class="variable">$gift</span> = <span class="keyword">new</span> ActivityHappyNewYearModel() ;</span><br><span class="line">	<span class="keyword">if</span> ( <span class="variable">$gift</span>-&gt;count(<span class="string">'gift_id'</span>) &gt;= <span class="number">7850</span> )&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span> ;</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="variable">$resMoney</span> = <span class="number">0</span> ;</span><br><span class="line">		<span class="variable">$money</span> = rand( <span class="number">1</span> , <span class="number">10000</span> );</span><br><span class="line">		<span class="comment">// 限定四档 红包的个数 </span></span><br><span class="line">		<span class="variable">$gift_first</span>  = <span class="number">0</span> ;</span><br><span class="line">		<span class="variable">$gift_second</span> = <span class="number">0</span> ;</span><br><span class="line">		<span class="variable">$gift_third</span>  = <span class="number">0</span> ;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>       ( <span class="variable">$money</span> &lt;= <span class="number">36</span>    )&#123;</span><br><span class="line">			<span class="variable">$gift_first</span> = <span class="variable">$gift</span>-&gt;where(<span class="string">'amount'</span>,<span class="string">'&gt;'</span>, <span class="number">500</span> )-&gt;where(<span class="string">'status'</span>,<span class="string">'!='</span>,<span class="number">666</span>)-&gt;where(<span class="string">'amount'</span>,<span class="string">'&lt;='</span>, <span class="number">1000</span> )-&gt;where(<span class="string">'status'</span>,<span class="number">1</span>)-&gt;count(<span class="string">'gift_id'</span>) ;</span><br><span class="line">			<span class="keyword">if</span> ( <span class="variable">$gift_first</span> &lt; <span class="number">20</span>  )&#123;</span><br><span class="line">				<span class="variable">$resMoney</span> = rand( <span class="number">501</span> , <span class="number">1000</span> );</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;<span class="keyword">else</span> <span class="keyword">if</span> ( <span class="variable">$money</span> &lt;= <span class="number">909</span>   )&#123;</span><br><span class="line">			<span class="variable">$gift_second</span> = <span class="variable">$gift</span>-&gt;where(<span class="string">'amount'</span>,<span class="string">'&gt;'</span>, <span class="number">200</span> )-&gt;where(<span class="string">'amount'</span>,<span class="string">'&lt;='</span>, <span class="number">500</span> )-&gt;where(<span class="string">'status'</span>,<span class="number">1</span>)-&gt;count(<span class="string">'gift_id'</span>) ;</span><br><span class="line">			<span class="keyword">if</span> ( <span class="variable">$gift_second</span> &lt; <span class="number">480</span> )&#123;</span><br><span class="line">				<span class="variable">$resMoney</span> = rand( <span class="number">201</span> , <span class="number">500</span> );</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;<span class="keyword">else</span> <span class="keyword">if</span> ( <span class="variable">$money</span> &lt;= <span class="number">10000</span>   )&#123;</span><br><span class="line">			<span class="variable">$gift_third</span> = <span class="variable">$gift</span>-&gt;where(<span class="string">'amount'</span>,<span class="string">'&gt;'</span>, <span class="number">99</span> )-&gt;where(<span class="string">'amount'</span>,<span class="string">'&lt;='</span>, <span class="number">200</span> )-&gt;where(<span class="string">'status'</span>,<span class="number">1</span>)-&gt;count(<span class="string">'gift_id'</span>) ;</span><br><span class="line">			<span class="keyword">if</span> ( <span class="variable">$gift_third</span> &lt; <span class="number">5000</span> )&#123;</span><br><span class="line">				<span class="variable">$resMoney</span> = rand( <span class="number">101</span> , <span class="number">200</span> );</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 抽到的档位已经发完的情况</span></span><br><span class="line">		<span class="keyword">if</span> ( !<span class="variable">$resMoney</span> )&#123;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> ( !<span class="variable">$resMoney</span> &amp;&amp; !<span class="variable">$gift_third</span> ) <span class="variable">$gift_third</span> = <span class="variable">$gift</span>-&gt;where(<span class="string">'amount'</span>,<span class="string">'&gt;'</span>, <span class="number">99</span> )-&gt;where(<span class="string">'amount'</span>,<span class="string">'&lt;='</span>, <span class="number">200</span> )-&gt;where(<span class="string">'status'</span>,<span class="number">1</span>)-&gt;count(<span class="string">'gift_id'</span>) ;</span><br><span class="line">			<span class="keyword">if</span> ( !<span class="variable">$resMoney</span> &amp;&amp; <span class="variable">$gift_third</span> &lt; <span class="number">5000</span> ) <span class="variable">$resMoney</span> = rand( <span class="number">101</span> , <span class="number">200</span> );</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> ( !<span class="variable">$resMoney</span> &amp;&amp; !<span class="variable">$gift_second</span> ) <span class="variable">$gift_second</span> = <span class="variable">$gift</span>-&gt;where(<span class="string">'amount'</span>,<span class="string">'&gt;'</span>, <span class="number">200</span> )-&gt;where(<span class="string">'amount'</span>,<span class="string">'&lt;='</span>, <span class="number">500</span> )-&gt;where(<span class="string">'status'</span>,<span class="number">1</span>)-&gt;count(<span class="string">'gift_id'</span>) ;</span><br><span class="line">			<span class="keyword">if</span> ( !<span class="variable">$resMoney</span> &amp;&amp; <span class="variable">$gift_second</span> &lt; <span class="number">480</span> ) <span class="variable">$resMoney</span> = rand( <span class="number">201</span> , <span class="number">500</span> );</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> ( !<span class="variable">$resMoney</span> &amp;&amp; !<span class="variable">$gift_first</span> ) <span class="variable">$gift_first</span> = <span class="variable">$gift</span>-&gt;where(<span class="string">'amount'</span>,<span class="string">'&gt;'</span>, <span class="number">500</span> )-&gt;where(<span class="string">'status'</span>,<span class="string">'!='</span>,<span class="number">666</span>)-&gt;where(<span class="string">'amount'</span>,<span class="string">'&lt;='</span>, <span class="number">1000</span> )-&gt;where(<span class="string">'status'</span>,<span class="number">1</span>)-&gt;count(<span class="string">'gift_id'</span>) ;</span><br><span class="line">			<span class="keyword">if</span> ( !<span class="variable">$resMoney</span> &amp;&amp; <span class="variable">$gift_first</span> &lt; <span class="number">20</span> ) <span class="variable">$resMoney</span> = rand( <span class="number">501</span> , <span class="number">1000</span> );</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="variable">$resMoney</span> ;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 红包发送情况统计</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">happy_new_year_stats</span> <span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>( !session(<span class="string">'adm_info.adm_id'</span>,<span class="keyword">null</span>) )&#123;</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">'没有权限'</span>;</span><br><span class="line">		<span class="keyword">return</span> ;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="variable">$gift</span> = <span class="keyword">new</span> ActivityHappyNewYearModel() ;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">'已发放红包总数：'</span> . <span class="variable">$gift</span>-&gt;where(<span class="string">'status'</span>,<span class="number">1</span>)-&gt;count(<span class="string">'gift_id'</span>) .<span class="string">'/5600 个 &lt;br&gt;'</span>;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">'已发放总金额：'</span> . <span class="variable">$gift</span>-&gt;where(<span class="string">'status'</span>,<span class="number">1</span>)-&gt;sum(<span class="string">'amount'</span>)/<span class="number">100</span> . <span class="string">'元 &lt;br&gt;'</span> ;	</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">'----------------------------------------- &lt;br&gt;'</span>;</span><br><span class="line"></span><br><span class="line">	<span class="variable">$gift_count</span> = <span class="variable">$gift</span>-&gt;where(<span class="string">'amount'</span>,<span class="string">'!='</span>, <span class="number">666</span> )-&gt;where(<span class="string">'status'</span>,<span class="number">1</span>)-&gt;count(<span class="string">'gift_id'</span>) ;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">'普通红包已发放：'</span> . <span class="variable">$gift_count</span> . <span class="string">'/5500 个&lt;br&gt;'</span>;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">'剩余普通红包：'</span> . ( <span class="number">5500</span> - <span class="variable">$gift_count</span> ) . <span class="string">'个&lt;br&gt;'</span> ;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">'----------------------------------------&lt;br&gt;'</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="variable">$gift_second</span> = <span class="variable">$gift</span>-&gt;where(<span class="string">'amount'</span>,<span class="string">'&gt;'</span>, <span class="number">99</span> )-&gt;where(<span class="string">'amount'</span>,<span class="string">'&lt;='</span>, <span class="number">200</span> )-&gt;where(<span class="string">'status'</span>,<span class="number">1</span>);</span><br><span class="line">	<span class="variable">$gift_second_count</span> = <span class="variable">$gift_second</span>-&gt;count(<span class="string">'gift_id'</span>) ;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">'1~2 元红包已发放：'</span> . <span class="variable">$gift_second_count</span> .<span class="string">'/5000&lt;br&gt;'</span>;</span><br><span class="line">	<span class="variable">$gift_second_amount</span> = <span class="variable">$gift_second</span>-&gt;sum(<span class="string">'amount'</span>)/<span class="number">100</span> ;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">'总金额：'</span> . <span class="variable">$gift_second_amount</span> .<span class="string">'&lt;br&gt;'</span> ;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">'中位值*总数：'</span> . <span class="variable">$gift_second_count</span>*<span class="number">1.5</span> .<span class="string">'&lt;br&gt;'</span> ;</span><br><span class="line"></span><br><span class="line">	<span class="variable">$gift_third</span> = <span class="variable">$gift</span>-&gt;where(<span class="string">'amount'</span>,<span class="string">'&gt;'</span>, <span class="number">200</span> )-&gt;where(<span class="string">'amount'</span>,<span class="string">'&lt;='</span>, <span class="number">500</span> )-&gt;where(<span class="string">'status'</span>,<span class="number">1</span>);</span><br><span class="line">	<span class="variable">$gift_third_count</span> = <span class="variable">$gift_third</span>-&gt;count(<span class="string">'gift_id'</span>) ;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">'2~5 元红包已发放：'</span> . <span class="variable">$gift_third_count</span> .<span class="string">'/480 &lt;br&gt;'</span>;</span><br><span class="line">	<span class="variable">$gift_third_amount</span> = <span class="variable">$gift_third</span>-&gt;sum(<span class="string">'amount'</span>)/<span class="number">100</span> ;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">'总金额：'</span> . <span class="variable">$gift_third_amount</span> .<span class="string">'&lt;br&gt;'</span> ;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">'中位值*总数：'</span> . <span class="variable">$gift_third_count</span>*<span class="number">3.5</span> .<span class="string">'&lt;br&gt;'</span> ;</span><br><span class="line"></span><br><span class="line">	<span class="variable">$gift_forth</span> = <span class="variable">$gift</span>-&gt;where(<span class="string">'amount'</span>,<span class="string">'&gt;'</span>, <span class="number">500</span> )-&gt;where(<span class="string">'amount'</span>,<span class="string">'&lt;='</span>, <span class="number">1000</span> )-&gt;where(<span class="string">'amount'</span>,<span class="string">'!='</span>, <span class="number">666</span> )-&gt;where(<span class="string">'status'</span>,<span class="number">1</span>);</span><br><span class="line">	<span class="variable">$gift_forth_count</span> = <span class="variable">$gift_forth</span>-&gt;count(<span class="string">'gift_id'</span>);</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">'5~10 元红包已发放：'</span> . <span class="variable">$gift_forth_count</span> .<span class="string">'/20&lt;br&gt;'</span> ;</span><br><span class="line">	<span class="variable">$gift_forth_amount</span> = <span class="variable">$gift_forth</span>-&gt;sum(<span class="string">'amount'</span>)/<span class="number">100</span> ;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">'总金额：'</span> . <span class="variable">$gift_forth_amount</span> .<span class="string">'&lt;br&gt;'</span> ;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">'中位值*总数：'</span> . <span class="variable">$gift_forth_count</span>*<span class="number">7.5</span> .<span class="string">'&lt;br&gt;'</span> ;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">echo</span> <span class="string">'----------------------------------------&lt;br&gt;'</span>;</span><br><span class="line">	<span class="variable">$total</span> = <span class="variable">$gift_second_amount</span> + <span class="variable">$gift_third_amount</span> + <span class="variable">$gift_forth_amount</span> ;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">'普通红包已发放总金额：'</span> . <span class="variable">$total</span> .<span class="string">'元&lt;br&gt;'</span> ;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">echo</span> <span class="string">'----------------------------------------&lt;br&gt;'</span>;</span><br><span class="line">	<span class="variable">$seed_count</span> = <span class="variable">$gift</span>-&gt;where( <span class="string">'amount'</span>, <span class="string">'='</span> , <span class="number">666</span> )-&gt;where(<span class="string">'status'</span>,<span class="number">1</span>)-&gt;count(<span class="string">'gift_id'</span>) ;</span><br><span class="line">       <span class="keyword">echo</span> <span class="string">'666红包已发放：'</span> . <span class="variable">$seed_count</span> . <span class="string">'/100 个&lt;br&gt;'</span> ;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">'剩余666红包：'</span> . ( <span class="number">100</span> - <span class="variable">$seed_count</span> ) . <span class="string">'个&lt;br&gt;'</span> ;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">'总金额：'</span> . ( <span class="variable">$seed_count</span>*<span class="number">666</span>/<span class="number">100</span> ) . <span class="string">'元&lt;br&gt;'</span> ;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">echo</span> <span class="string">'-----------------------------------------&lt;br&gt;'</span>;</span><br><span class="line">	<span class="variable">$gift_error</span> =  ActivityHappyNewYearModel::where(<span class="string">'status'</span>,<span class="string">'='</span>, <span class="number">99</span> );</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">'异常（调用微信接口错误）红包数：'</span> . <span class="variable">$gift_error</span>-&gt;count() .<span class="string">'&lt;br&gt;'</span>;</span><br><span class="line">	<span class="keyword">echo</span> implode( <span class="string">'&lt;br&gt;'</span> , <span class="variable">$gift_error</span>-&gt;lists(<span class="string">'remark'</span>)-&gt;toArray() );</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/php-wechat/">php wechat</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>










  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/3/">Next &raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2020 Zoe Ying
    	</div>
      	<div class="footer-right">
      		<a href="https://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="https://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js" type="text/javascript"></script>
<script src="/js/main.js" type="text/javascript"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
  <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1258930011'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s4.cnzz.com/z_stat.php%3Fid%3D1258930011%26online%3D1%26show%3Dline' type='text/javascript'%3E%3C/script%3E"));</script>
</body>
</html>